<!DOCTYPE html>
<meta charset="utf-8">
<style>
  .countries {
    fill: none;
    stroke: #fff;
    stroke-linejoin: round;
  }
  .legendThreshold {
      font-size: 12px;
      font-family: sans-serif;
  }
  .caption {
      fill: #000;
      text-anchor: start;
      font-weight: bold;
  }
</style>
<svg width="960" height="600"></svg>
<div id="circularPacking"></div>

<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
<script src="https://d3js.org/d3-geo-projection.v2.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3-legend/2.24.0/d3-legend.js"></script>
<script>
var allData = {}
var selectedCircles = []
// The svg
var svg = d3.select("svg"),
    width = +svg.attr("width"),
    height = +svg.attr("height");

function drawMap(topo) {
    // Map and projection
    var path = d3.geoPath();
    var projection = d3.geoNaturalEarth()
        .scale(width / 2 / Math.PI)
        .translate([width / 2, height / 2])
    var path = d3.geoPath()
        .projection(projection);

    // Data and color scale

    var data = d3.map();
    var colorScheme = d3.schemeReds[6];
    colorScheme.unshift("#eee")
    // var colorScale = d3.scale.linear().range(["#ffffff", "#7f0000"]).interpolate(d3.interpolateLab);
    var colorScale = d3.scaleLinear()
        .domain([0, d3.max(allData, function(d) { return d.country_value; }) ])
        .range(colorScheme);
    var colorScale = d3.scaleThreshold()
    .domain([100000, 1000000, 10000000, 30000000, 100000000, 500000000])
    .range(d3.schemeBlues[7]);
    // Legend
    var g = svg.append("g")
        .attr("class", "legendThreshold")
        .attr("transform", "translate(20,20)");
    g.append("text")
        .attr("class", "caption")
        .attr("x", 0)
        .attr("y", -6)
        .text("Students");
    var labels = ['0-10K', '10K-100K', '100K-1M', '1M-3M', '3M-10M', '10M-50M', '> 1000'];
    var legend = d3.legendColor()
        .labels(function (d) { return labels[d.i]; })
        .shapePadding(4)
        .scale(colorScale);
    svg.select(".legendThreshold")
        .call(legend);

        svg.append("g")
          .attr("class", "countries")
          .selectAll("path")
          .data(topo.features)
          .enter().append("path")
              .attr("fill", function (d){
                  // Pull data for this country
                  d.total = allData[d.id] ? allData[d.id].total_msw : 0;
                  d.population = allData[d.id] ? allData[d.id].population : 0;
                  d.country_name = allData[d.id] ? allData[d.id].country_name : ""
                  // Set the color
                  return colorScale(d.total);
              })
              .attr("d", path)
              .on("click", clicked)

} 

function clicked(d) {
  console.log(d)
  selectedCircles.push(d)
//   drawCircularPacking()
}

// set the dimensions and margins of the graph
var width2 = 600
var height2 = 600

region_id_to_to_name = {
  LCN: "Latin America & Caribbean",
  SAS: "South Asia",
  ECS: "Europe & Central Asia",
  MEA: "Middle East & North Africa",
  EAS: "East Asia & Pacific",
  SSF: "Sub-Saharan Africa",
  NAC: "North America"
}

// append the svg object to the body of the page
var circleVis = d3.select("#circularPacking")
  .append("svg")
    .attr("width", width2)
    .attr("height", height2)

function drawCircularPacking(circleData) {
  // Color palette for continents?
  circleData = circleData.sort(function(a,b){ return b.region_name - a.region_name; });
    console.log(circleData)
  var color = d3.scaleOrdinal()
    .domain(Object.values(region_id_to_to_name))
    .range(["#66c2a5", "#fc8d62", "#8da0cb", "#e78ac3", "#a6d854", "#ffd92f", "#e5c494", "#b3b3b3"]);

  // Size scale for countries
  var size = d3.scaleLinear()
    .domain([0, 140000000])
    .range([10, 30])  // circle will be between 7 and 55 px wide

  // create a tooltip
  var Tooltip = d3.select("#circularPacking")
    .append("div")
    .style("opacity", 0)
    .attr("class", "tooltip")
    .style("background-color", "white")
    .style("border", "solid")
    .style("border-width", "2px")
    .style("border-radius", "5px")
    .style("padding", "5px")

  // Three function that change the tooltip when user hover / move / leave a cell
  var mouseover = function(d) {
    Tooltip
      .style("opacity", 1)
  }
  var mousemove = function(d) {
    Tooltip
      .html('<u>' + d.country_name + '</u>' + "<br>" + d.total_msw + " tons of trash")
      .style("left", (d3.mouse(this)[0]+20) + "px")
      .style("top", (d3.mouse(this)[1]) + "px")
  }
  var mouseleave = function(d) {
    Tooltip
      .style("opacity", 0)
  }

  // Initialize the circle: all located at the center of the svg area
  var node = circleVis.append("g")
    .selectAll("circle")
    .data(circleData)
    .enter()
    .append("circle")
      .attr("class", "node")
      .attr("r", function(d){ return size(d.total_msw)})
      .attr("cx", width2 / 2)
      .attr("cy", height2 / 2)
      .style("fill", function(d){ return color(d.region_name)})
      .style("fill-opacity", 0.8)
      .attr("stroke", "black")
      .style("stroke-width", 1)
      .on("mouseover", mouseover) // What to do when hovered
      .on("mousemove", mousemove)
      .on("mouseleave", mouseleave)
      .call(d3.drag() // call specific function when circle is dragged
           .on("start", dragstarted)
           .on("drag", dragged)
           .on("end", dragended));

  // Features of the forces applied to the nodes:
  var simulation = d3.forceSimulation()
      .force("center", d3.forceCenter().x(width2 / 2).y(height2/ 2)) // Attraction to the center of the svg area
      .force("charge", d3.forceManyBody().strength(.1)) // Nodes are attracted one each other of value is > 0
      .force("collide", d3.forceCollide().strength(.2).radius(function(d){ return (size(d.total_msw)+3) }).iterations(1)) // Force that avoids circle overlapping

  // Apply these forces to the nodes and update their positions.
  // Once the force algorithm is happy with positions ('alpha' value is low enough), simulations will stop.

  simulation
      .nodes(circleData)
      .on("tick", function(d){
        node
            .attr("cx", function(d){ return d.x; })
            .attr("cy", function(d){ return d.y; })
      });
   // What happens when a circle is dragged?
   function dragstarted(d) {
    if (!d3.event.active) simulation.alphaTarget(.03).restart();
    d.fx = d.x;
    d.fy = d.y;
  }
  function dragged(d) {
    d.fx = d3.event.x;
    d.fy = d3.event.y;
  }
  function dragended(d) {
    if (!d3.event.active) simulation.alphaTarget(.03);
    d.fx = null;
    d.fy = null;
  }
}

 
// Load external data and boot
var circleData = []
d3.queue()
    .defer(d3.json, "http://enjalot.github.io/wwsd/data/world/world-110m.geojson")
    .defer(d3.csv, "data_resources/country_level_data.csv", function(d) { 
      let country_value = d.total_msw_total_msw_generated_tons_year ? parseInt(d.total_msw_total_msw_generated_tons_year) : 0
      let country_code = d.iso3c
      let population = d.population_population_number_of_people ? parseInt(d.population_population_number_of_people) : 0
      let country_name = d.country_name
      let region_name = region_id_to_to_name[d.region_id]
      allData[country_code] = {total_msw: country_value, population: population, country_name: country_name, region_name: region_name}
      circleData.push( {total_msw: country_value, population: population, country_name: country_name, region_name: region_name})
    })
    .await(ready);

function ready(error, topo) {
    if (error) throw error;
    console.log(allData)
    // Draw the map
    drawMap(topo)
    drawCircularPacking(circleData)
    console.log(circleData)
}
</script>